<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººæƒ…å¾€æ¥è®°å½•æœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f7f7f7;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f7f7f7;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #ececec;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .records-list {
            margin-top: 30px;
        }

        .record-card {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .record-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .record-card.received {
            border-left-color: #52c41a;
        }

        .record-card.given {
            border-left-color: #ff4757;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .record-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .record-amount {
            font-size: 20px;
            font-weight: bold;
        }

        .record-amount.received {
            color: #52c41a;
        }

        .record-amount.given {
            color: #ff4757;
        }

        .record-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .record-detail {
            display: flex;
            align-items: center;
        }

        .record-detail strong {
            margin-right: 5px;
        }

        .record-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 12px;
        }

        .btn-delete {
            background: #ff4757;
            color: white;
        }

        .btn-delete:hover {
            background: #ee5a6f;
        }

        .btn-return {
            background: #52c41a;
            color: white;
        }

        .btn-return:hover {
            background: #73d13d;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #52c41a 0%, #95de64 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar select, .filter-bar input {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state img {
            width: 150px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .contact-group {
            margin-bottom: 30px;
        }

        .contact-group-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .contact-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .contact-item:hover {
            background: #fff;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .contact-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .contact-stats {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .contact-balance {
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
        }

        .contact-balance.positive {
            color: #52c41a;
        }

        .contact-balance.negative {
            color: #ff4757;
        }

        .year-stat-card {
            flex: 1;
            min-width: 200px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .year-stat-card:hover {
            background: #fff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .year-stat-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .year-stat-year {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .year-stat-amount {
            font-size: 18px;
            margin: 5px 0;
        }

        .year-stat-count {
            font-size: 14px;
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f0f0f0;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

        #contact-suggestions {
            margin-top: 2px;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: #f5f5f5;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: bold;
            color: #333;
        }

        .suggestion-info {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #fff7e6;
            color: #fa8c16;
        }

        .status-returned {
            background: #f6ffed;
            color: #52c41a;
        }

        @media (max-width: 768px) {
            .form-row, .record-details, .statistics {
                grid-template-columns: 1fr;
            }

            .record-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .record-amount {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’ äººæƒ…å¾€æ¥è®°å½•æœ¬</h1>
            <p>è®°å½•æ¯ä¸€ä»½æƒ…è°Šï¼Œç®¡ç†éšç¤¼è¿˜ç¤¼</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">ğŸ“ æ·»åŠ è®°å½•</button>
            <button class="tab" onclick="switchTab('list')">ğŸ“‹ è®°å½•åˆ—è¡¨</button>
            <button class="tab" onclick="switchTab('gift-book')">ğŸ ç¤¼è–„ç®¡ç†</button>
            <button class="tab" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡åˆ†æ</button>
        </div>

        <div class="content">
            <!-- æ·»åŠ è®°å½• -->
            <div id="add-tab" class="tab-content active">
                <form id="record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">è®°å½•ç±»å‹ *</label>
                            <select id="type" required onchange="toggleGiftBookSelection()">
                                <option value="received">æ”¶ç¤¼ï¼ˆåˆ«äººç»™æˆ‘ï¼‰</option>
                                <option value="given">é€ç¤¼ï¼ˆæˆ‘ç»™åˆ«äººï¼‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="name">å§“å *</label>
                            <input type="text" id="name" placeholder="è¯·è¾“å…¥å¯¹æ–¹å§“å" required autocomplete="off" oninput="showContactSuggestions()">
                            <div id="contact-suggestions" style="display: none; position: absolute; background: white; border: 1px solid #d9d9d9; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                        </div>
                    </div>

                    <div class="form-group" id="giftbook-selection" style="display: none;">
                        <label for="giftbook">å…³è”ç¤¼è–„</label>
                        <select id="giftbook" onchange="onGiftBookChange()">
                            <option value="">ä¸å…³è”ç¤¼è–„</option>
                        </select>
                        <small style="color: #999; display: block; margin-top: 5px;">ğŸ’¡ é€‰æ‹©ç¤¼è–„åï¼Œæ­¤æ”¶ç¤¼è®°å½•å°†è‡ªåŠ¨æ·»åŠ åˆ°å¯¹åº”ç¤¼è–„ä¸­ï¼Œå¹¶è‡ªåŠ¨å¡«å……äº‹ç”±å’Œæ—¥æœŸ</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">é‡‘é¢ *</label>
                            <input type="number" id="amount" placeholder="è¯·è¾“å…¥é‡‘é¢" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="date">æ—¥æœŸ *</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="event">äº‹ç”± *</label>
                            <select id="event" required>
                                <option value="wedding">ç»“å©š</option>
                                <option value="birthday">ç”Ÿæ—¥</option>
                                <option value="housewarming">ä¹”è¿</option>
                                <option value="baby">æ»¡æœˆ/ç™¾æ—¥</option>
                                <option value="funeral">ä¸§äº‹</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="relationship">å…³ç³»</label>
                            <input type="text" id="relationship" placeholder="å¦‚ï¼šåŒäº‹ã€æœ‹å‹ã€äº²æˆš">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="location">åœ°ç‚¹</label>
                        <input type="text" id="location" placeholder="è¯·è¾“å…¥åœ°ç‚¹">
                    </div>

                    <div class="form-group">
                        <label for="notes">å¤‡æ³¨</label>
                        <textarea id="notes" placeholder="å¯ä»¥æ·»åŠ ä¸€äº›å¤‡æ³¨ä¿¡æ¯..."></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜è®°å½•</button>
                        <button type="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
                    </div>
                </form>
            </div>

            <!-- è®°å½•åˆ—è¡¨ -->
            <div id="list-tab" class="tab-content">
                <div class="filter-bar">
                    <select id="filter-type" onchange="filterRecords()">
                        <option value="all">å…¨éƒ¨è®°å½•</option>
                        <option value="received">æ”¶ç¤¼è®°å½•</option>
                        <option value="given">é€ç¤¼è®°å½•</option>
                    </select>
                    <select id="filter-year" onchange="filterRecords()">
                        <option value="all">å…¨éƒ¨å¹´ä»½</option>
                    </select>
                    <input type="text" id="search-name" placeholder="æœç´¢å§“å..." onkeyup="filterRecords()">
                </div>
                <div id="records-container" class="records-list"></div>
            </div>

            <!-- ç¤¼è–„ç®¡ç† -->
            <div id="gift-book-tab" class="tab-content">
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="toggleGiftBookForm()" id="create-giftbook-btn">
                        â• åˆ›å»ºç¤¼è–„
                    </button>
                </div>

                <div id="gift-book-form-container" style="display: none; margin-bottom: 30px;">
                    <div style="background: #f9f9f9; padding: 25px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>ğŸ“ åˆ›å»ºæ–°ç¤¼è–„</h3>
                            <button class="btn btn-secondary" onclick="toggleGiftBookForm()" style="padding: 8px 15px;">
                                âœ– å…³é—­
                            </button>
                        </div>
                        <form id="gift-book-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gb-event-name">äº‹ç”±åç§° *</label>
                                    <input type="text" id="gb-event-name" placeholder="å¦‚ï¼šå„¿å­ç»“å©šã€å¥³å„¿æ»¡æœˆ" required>
                                </div>
                                <div class="form-group">
                                    <label for="gb-event-type">äº‹ç”±ç±»å‹ *</label>
                                    <select id="gb-event-type" required>
                                        <option value="wedding">ç»“å©š</option>
                                        <option value="birthday">ç”Ÿæ—¥</option>
                                        <option value="housewarming">ä¹”è¿</option>
                                        <option value="baby">æ»¡æœˆ/ç™¾æ—¥</option>
                                        <option value="other">å…¶ä»–</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gb-date">æ—¥æœŸ *</label>
                                    <input type="date" id="gb-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="gb-location">åœ°ç‚¹</label>
                                    <input type="text" id="gb-location" placeholder="è¯·è¾“å…¥åœ°ç‚¹">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="gb-notes">å¤‡æ³¨</label>
                                <textarea id="gb-notes" placeholder="å¯ä»¥æ·»åŠ ä¸€äº›å¤‡æ³¨ä¿¡æ¯..."></textarea>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary">ğŸ’¾ åˆ›å»ºç¤¼è–„</button>
                                <button type="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="gift-books-container"></div>
            </div>

            <!-- ç»Ÿè®¡åˆ†æ -->
            <div id="stats-tab" class="tab-content">
                <div class="statistics" id="statistics"></div>
                
                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button class="btn" style="flex: 1; background: #667eea; color: white;" onclick="showStatsView('summary')">
                        ğŸ“Š æ•°æ®ç»Ÿè®¡
                    </button>
                    <button class="btn" style="flex: 1; background: #52c41a; color: white;" onclick="showStatsView('contacts')">
                        ğŸ‘¥ äº²å‹å½•
                    </button>
                </div>

                <!-- æ•°æ®ç»Ÿè®¡è§†å›¾ -->
                <div id="summary-view" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡</h3>
                    
                    <!-- å¹´ä»½ç»Ÿè®¡ -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-bottom: 15px;">ğŸ“… å¹´åº¦ç»Ÿè®¡</h4>
                        <div id="year-stats" style="display: flex; gap: 15px; flex-wrap: wrap;"></div>
                    </div>

                    <!-- äº‹ç”±ç»Ÿè®¡ -->
                    <div id="event-stats-section">
                        <h4 style="margin-bottom: 15px;" id="event-stats-title">ğŸ“Š äº‹ç”±ç»Ÿè®¡ï¼ˆå…¨éƒ¨ï¼‰</h4>
                        <div id="detailed-stats"></div>
                    </div>
                </div>

                <!-- äº²å‹å½•è§†å›¾ -->
                <div id="contacts-view" style="margin-top: 30px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ğŸ‘¥ äº²å‹å½•</h3>
                        <div style="flex: 1; max-width: 400px; margin-left: 20px;">
                            <input type="text" id="contact-search" placeholder="ğŸ” æœç´¢äº²å‹å§“å..." 
                                onkeyup="filterContacts()" 
                                style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                    <div id="contacts-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº²å‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="contact-modal" class="modal">
        <div class="modal-content" id="contact-modal-content">
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨ï¼ˆä½¿ç”¨APIï¼‰
        let records = [];
        let giftBooks = [];
        
        // API åŸºç¡€URL
        const API_BASE = window.location.origin;
        
        // ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const [recordsRes, giftBooksRes] = await Promise.all([
                    fetch(`${API_BASE}/api/records`),
                    fetch(`${API_BASE}/api/giftbooks`)
                ]);
                
                records = await recordsRes.json();
                giftBooks = await giftBooksRes.json();
                
                console.log('æ•°æ®åŠ è½½æˆåŠŸ:', { records: records.length, giftBooks: giftBooks.length });
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨localStorageï¼ˆå‘åå…¼å®¹ï¼‰
                records = JSON.parse(localStorage.getItem('renqing-records')) || [];
                giftBooks = JSON.parse(localStorage.getItem('renqing-giftbooks')) || [];
            }
        }

        // äº‹ç”±æ˜ å°„
        const eventMap = {
            wedding: 'ç»“å©š',
            birthday: 'ç”Ÿæ—¥',
            housewarming: 'ä¹”è¿',
            baby: 'æ»¡æœˆ/ç™¾æ—¥',
            funeral: 'ä¸§äº‹',
            other: 'å…¶ä»–'
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åŠ è½½æ•°æ®
            await loadData();
            
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('gb-date').valueAsDate = new Date();
            
            // æ¸²æŸ“è®°å½•åˆ—è¡¨
            renderRecords();
            renderStatistics();
            renderGiftBooks();
            updateYearFilter();
            
            // åˆå§‹åŒ–ç¤¼è–„é€‰æ‹©æ˜¾ç¤ºçŠ¶æ€
            toggleGiftBookSelection();
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­è”æƒ³æç¤º
            document.addEventListener('click', function(e) {
                if (e.target.id !== 'name') {
                    document.getElementById('contact-suggestions').style.display = 'none';
                }
            });
        });

        // æ˜¾ç¤ºè”ç³»äººå»ºè®®
        function showContactSuggestions() {
            const input = document.getElementById('name');
            const searchText = input.value.trim().toLowerCase();
            const suggestionsDiv = document.getElementById('contact-suggestions');
            
            if (!searchText) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // ä»æ‰€æœ‰è®°å½•ä¸­æå–å”¯ä¸€çš„è”ç³»äºº
            const contactsMap = {};
            records.forEach(record => {
                const name = record.name;
                if (name.toLowerCase().includes(searchText)) {
                    if (!contactsMap[name]) {
                        contactsMap[name] = {
                            name: name,
                            relationship: record.relationship || 'æœªçŸ¥',
                            lastEvent: record.event,
                            count: 0
                        };
                    }
                    contactsMap[name].count++;
                }
            });
            
            const matches = Object.values(contactsMap);
            
            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºå»ºè®®åˆ—è¡¨
            suggestionsDiv.innerHTML = matches.map(contact => `
                <div class="suggestion-item" onclick="selectContact('${contact.name}', '${contact.relationship}')">
                    <div class="suggestion-name">${contact.name}</div>
                    <div class="suggestion-info">${contact.relationship} Â· å¾€æ¥${contact.count}æ¬¡ Â· æœ€è¿‘ï¼š${eventMap[contact.lastEvent]}</div>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
            
            // è®¾ç½®ä½ç½®ï¼ˆç›¸å¯¹äºè¾“å…¥æ¡†ï¼‰
            const inputRect = input.getBoundingClientRect();
            suggestionsDiv.style.width = inputRect.width + 'px';
        }

        // é€‰æ‹©è”ç³»äºº
        function selectContact(name, relationship) {
            document.getElementById('name').value = name;
            if (relationship && relationship !== 'æœªçŸ¥') {
                document.getElementById('relationship').value = relationship;
            }
            document.getElementById('contact-suggestions').style.display = 'none';
        }

        // æ›´æ–°å¹´ä»½ç­›é€‰å™¨
        function updateYearFilter() {
            const years = new Set();
            records.forEach(record => {
                const year = new Date(record.date).getFullYear();
                years.add(year);
            });
            
            const yearFilter = document.getElementById('filter-year');
            yearFilter.innerHTML = '<option value="all">å…¨éƒ¨å¹´ä»½</option>';
            
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + ' å¹´';
                yearFilter.appendChild(option);
            });
        }

        // è¡¨å•æäº¤
        document.getElementById('record-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const record = {
                id: Date.now(),
                type: document.getElementById('type').value,
                name: document.getElementById('name').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value,
                event: document.getElementById('event').value,
                relationship: document.getElementById('relationship').value,
                location: document.getElementById('location').value,
                notes: document.getElementById('notes').value,
                giftBookId: document.getElementById('giftbook').value || null,
                createTime: new Date().toISOString()
            };

            records.push(record);
            
            // å¦‚æœå…³è”äº†ç¤¼è–„ï¼ŒåŒæ—¶æ·»åŠ åˆ°ç¤¼è–„çš„å®¾å®¢åˆ—è¡¨
            if (record.type === 'received' && record.giftBookId) {
                const book = giftBooks.find(b => b.id == record.giftBookId);
                if (book) {
                    const guest = {
                        id: record.id,
                        name: record.name,
                        amount: record.amount,
                        relationship: record.relationship || ''
                    };
                    book.guests.push(guest);
                    saveGiftBooks();
                }
            }
            
            saveRecords();
            
            // é‡ç½®è¡¨å•
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('giftbook-selection').style.display = 'none';
            
            // åˆ‡æ¢åˆ°åˆ—è¡¨é¡µé¢
            switchTab('list');
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('âœ… è®°å½•å·²æˆåŠŸä¿å­˜ï¼');
        });

        // åˆ‡æ¢ç¤¼è–„é€‰æ‹©æ˜¾ç¤º
        function toggleGiftBookSelection() {
            const type = document.getElementById('type').value;
            const giftbookDiv = document.getElementById('giftbook-selection');
            
            if (type === 'received') {
                giftbookDiv.style.display = 'block';
                updateGiftBookOptions();
            } else {
                giftbookDiv.style.display = 'none';
                // æ¸…ç©ºé€‰æ‹©
                document.getElementById('giftbook').value = '';
            }
        }

        // æ›´æ–°ç¤¼è–„é€‰é¡¹
        function updateGiftBookOptions() {
            const select = document.getElementById('giftbook');
            select.innerHTML = '<option value="">ä¸å…³è”ç¤¼è–„</option>';
            
            giftBooks.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = `${book.eventName} (${book.date})`;
                select.appendChild(option);
            });
        }

        // å½“ç¤¼è–„é€‰æ‹©å˜åŒ–æ—¶
        function onGiftBookChange() {
            const giftbookId = document.getElementById('giftbook').value;
            
            if (giftbookId) {
                const book = giftBooks.find(b => b.id == giftbookId);
                if (book) {
                    // è‡ªåŠ¨å¡«å……äº‹ç”±å’Œæ—¥æœŸ
                    document.getElementById('event').value = book.eventType;
                    document.getElementById('date').value = book.date;
                    // å¦‚æœç¤¼è–„æœ‰åœ°ç‚¹ï¼Œä¹Ÿå¯ä»¥å¡«å……
                    if (book.location && !document.getElementById('location').value) {
                        document.getElementById('location').value = book.location;
                    }
                }
            }
        }

        // ä¿å­˜åˆ°æœåŠ¡å™¨
        async function saveRecords() {
            try {
                await fetch(`${API_BASE}/api/records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(records)
                });
                // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                localStorage.setItem('renqing-records', JSON.stringify(records));
            } catch (error) {
                console.error('ä¿å­˜è®°å½•å¤±è´¥:', error);
                // å¦‚æœAPIå¤±è´¥ï¼Œè‡³å°‘ä¿å­˜åˆ°localStorage
                localStorage.setItem('renqing-records', JSON.stringify(records));
            }
            renderRecords();
            renderStatistics();
            updateYearFilter();
        }

        // ä¿å­˜ç¤¼è–„åˆ°æœåŠ¡å™¨
        async function saveGiftBooks() {
            try {
                await fetch(`${API_BASE}/api/giftbooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(giftBooks)
                });
                // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                localStorage.setItem('renqing-giftbooks', JSON.stringify(giftBooks));
            } catch (error) {
                console.error('ä¿å­˜ç¤¼è–„å¤±è´¥:', error);
                // å¦‚æœAPIå¤±è´¥ï¼Œè‡³å°‘ä¿å­˜åˆ°localStorage
                localStorage.setItem('renqing-giftbooks', JSON.stringify(giftBooks));
            }
            renderGiftBooks();
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'list') {
                renderRecords();
            } else if (tabName === 'stats') {
                renderStatistics();
            }
        }

        // æ¸²æŸ“è®°å½•åˆ—è¡¨
        function renderRecords(filteredRecords = null) {
            const container = document.getElementById('records-container');
            const recordsToShow = filteredRecords || records;
            
            if (recordsToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 48px;">ğŸ“­</p>
                        <p style="font-size: 18px; margin-top: 10px;">æš‚æ— è®°å½•</p>
                        <p style="font-size: 14px; margin-top: 5px;">ç‚¹å‡»"æ·»åŠ è®°å½•"å¼€å§‹è®°å½•äººæƒ…å¾€æ¥</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedRecords = [...recordsToShow].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedRecords.map(record => {
                const linkedBook = record.giftBookId ? giftBooks.find(b => b.id == record.giftBookId) : null;
                
                return `
                <div class="record-card ${record.type}" id="record-${record.id}">
                    <div class="record-header">
                        <div>
                            <span class="record-name">${record.name}</span>
                            ${linkedBook ? 
                                `<span class="status-badge" style="background: #e6f7ff; color: #1890ff;">ğŸ“– ${linkedBook.eventName}</span>` : ''}
                        </div>
                        <div class="record-amount ${record.type}">
                            ${record.type === 'received' ? '+' : '-'}Â¥${record.amount.toFixed(2)}
                        </div>
                    </div>
                    
                    <!-- ç¼–è¾‘è¡¨å• -->
                    <div id="edit-form-${record.id}" style="display: none; background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px;">å§“å</label>
                            <input type="text" id="edit-name-${record.id}" value="${record.name}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px;">é‡‘é¢</label>
                                <input type="number" id="edit-amount-${record.id}" value="${record.amount}" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="font-size: 12px;">æ—¥æœŸ</label>
                                <input type="date" id="edit-date-${record.id}" value="${record.date}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px;">äº‹ç”±</label>
                                <select id="edit-event-${record.id}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="wedding" ${record.event === 'wedding' ? 'selected' : ''}>ç»“å©š</option>
                                    <option value="birthday" ${record.event === 'birthday' ? 'selected' : ''}>ç”Ÿæ—¥</option>
                                    <option value="housewarming" ${record.event === 'housewarming' ? 'selected' : ''}>ä¹”è¿</option>
                                    <option value="baby" ${record.event === 'baby' ? 'selected' : ''}>æ»¡æœˆ/ç™¾æ—¥</option>
                                    <option value="funeral" ${record.event === 'funeral' ? 'selected' : ''}>ä¸§äº‹</option>
                                    <option value="other" ${record.event === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px;">å…³ç³»</label>
                                <input type="text" id="edit-relationship-${record.id}" value="${record.relationship || ''}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px;">åœ°ç‚¹</label>
                            <input type="text" id="edit-location-${record.id}" value="${record.location || ''}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px;">å¤‡æ³¨</label>
                            <textarea id="edit-notes-${record.id}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; min-height: 60px;">${record.notes || ''}</textarea>
                        </div>
                        ${record.type === 'received' ? `
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px;">å…³è”ç¤¼è–„</label>
                                <select id="edit-giftbook-${record.id}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="">ä¸å…³è”ç¤¼è–„</option>
                                    ${giftBooks.map(book => `
                                        <option value="${book.id}" ${record.giftBookId == book.id ? 'selected' : ''}>
                                            ${book.eventName} (${book.date})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-small" style="background: #52c41a; color: white; flex: 1;" onclick="saveEdit(${record.id})">
                                âœ… ä¿å­˜ä¿®æ”¹
                            </button>
                            <button class="btn btn-small" style="background: #d9d9d9; color: #333; flex: 1;" onclick="cancelEdit(${record.id})">
                                âŒ å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ˜¾ç¤ºè¯¦æƒ… -->
                    <div id="display-${record.id}">
                        <div class="record-details">
                            <div class="record-detail">
                                <strong>äº‹ç”±ï¼š</strong>${eventMap[record.event]}
                            </div>
                            <div class="record-detail">
                                <strong>æ—¥æœŸï¼š</strong>${record.date}
                            </div>
                            ${record.relationship ? `
                                <div class="record-detail">
                                    <strong>å…³ç³»ï¼š</strong>${record.relationship}
                                </div>
                            ` : ''}
                            ${record.location ? `
                                <div class="record-detail">
                                    <strong>åœ°ç‚¹ï¼š</strong>${record.location}
                                </div>
                            ` : ''}
                        </div>
                        ${record.notes ? `
                            <div style="margin-top: 10px; color: #666; font-size: 14px;">
                                <strong>å¤‡æ³¨ï¼š</strong>${record.notes}
                            </div>
                        ` : ''}
                        <div class="record-actions">
                            <button class="btn btn-small" style="background: #1890ff; color: white;" onclick="showEdit(${record.id})">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="btn btn-small btn-delete" onclick="deleteRecord(${record.id})">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // è¿‡æ»¤è®°å½•
        function filterRecords() {
            const typeFilter = document.getElementById('filter-type').value;
            const yearFilter = document.getElementById('filter-year').value;
            const searchName = document.getElementById('search-name').value.toLowerCase();
            
            let filtered = records.filter(record => {
                const matchType = typeFilter === 'all' || record.type === typeFilter;
                const recordYear = new Date(record.date).getFullYear().toString();
                const matchYear = yearFilter === 'all' || recordYear === yearFilter;
                const matchName = record.name.toLowerCase().includes(searchName);
                return matchType && matchYear && matchName;
            });
            
            renderRecords(filtered);
        }

        // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
        function showEdit(id) {
            document.getElementById(`display-${id}`).style.display = 'none';
            document.getElementById(`edit-form-${id}`).style.display = 'block';
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit(id) {
            document.getElementById(`display-${id}`).style.display = 'block';
            document.getElementById(`edit-form-${id}`).style.display = 'none';
        }

        // ä¿å­˜ç¼–è¾‘
        function saveEdit(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            const oldGiftBookId = record.giftBookId;
            const oldAmount = record.amount;
            const oldName = record.name;
            const oldRelationship = record.relationship;
            
            // æ›´æ–°è®°å½•
            record.name = document.getElementById(`edit-name-${id}`).value;
            record.amount = parseFloat(document.getElementById(`edit-amount-${id}`).value);
            record.date = document.getElementById(`edit-date-${id}`).value;
            record.event = document.getElementById(`edit-event-${id}`).value;
            record.relationship = document.getElementById(`edit-relationship-${id}`).value;
            record.location = document.getElementById(`edit-location-${id}`).value;
            record.notes = document.getElementById(`edit-notes-${id}`).value;
            
            // å¤„ç†ç¤¼è–„å…³è”å˜æ›´
            if (record.type === 'received') {
                const newGiftBookId = document.getElementById(`edit-giftbook-${id}`).value || null;
                
                // å¦‚æœç¤¼è–„å‘ç”Ÿå˜åŒ–
                if (oldGiftBookId != newGiftBookId) {
                    // ä»æ—§ç¤¼è–„åˆ é™¤
                    if (oldGiftBookId) {
                        const oldBook = giftBooks.find(b => b.id == oldGiftBookId);
                        if (oldBook) {
                            oldBook.guests = oldBook.guests.filter(g => g.id !== id);
                        }
                    }
                    
                    // æ·»åŠ åˆ°æ–°ç¤¼è–„
                    if (newGiftBookId) {
                        const newBook = giftBooks.find(b => b.id == newGiftBookId);
                        if (newBook) {
                            const guest = {
                                id: id,
                                name: record.name,
                                amount: record.amount,
                                relationship: record.relationship || ''
                            };
                            newBook.guests.push(guest);
                        }
                    }
                    
                    record.giftBookId = newGiftBookId;
                    saveGiftBooks();
                } else if (oldGiftBookId) {
                    // ç¤¼è–„æœªå˜ï¼Œä½†æ›´æ–°ç¤¼è–„ä¸­çš„å®¾å®¢ä¿¡æ¯
                    const book = giftBooks.find(b => b.id == oldGiftBookId);
                    if (book) {
                        const guest = book.guests.find(g => g.id === id);
                        if (guest) {
                            guest.name = record.name;
                            guest.amount = record.amount;
                            guest.relationship = record.relationship || '';
                        }
                        saveGiftBooks();
                    }
                }
            }
            
            saveRecords();
            cancelEdit(id);
            alert('âœ… ä¿®æ”¹å·²ä¿å­˜ï¼');
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                const record = records.find(r => r.id === id);
                
                // å¦‚æœè®°å½•å…³è”äº†ç¤¼è–„ï¼ŒåŒæ—¶ä»ç¤¼è–„ä¸­åˆ é™¤
                if (record && record.giftBookId) {
                    const book = giftBooks.find(b => b.id == record.giftBookId);
                    if (book) {
                        book.guests = book.guests.filter(g => g.id !== id);
                        saveGiftBooks();
                    }
                }
                
                records = records.filter(r => r.id !== id);
                saveRecords();
            }
        }

        // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
        function renderStatistics() {
            const totalReceived = records.filter(r => r.type === 'received')
                .reduce((sum, r) => sum + r.amount, 0);
            const totalGiven = records.filter(r => r.type === 'given')
                .reduce((sum, r) => sum + r.amount, 0);
            const balance = totalReceived - totalGiven;
            
            const statsContainer = document.getElementById('statistics');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">æ€»æ”¶å…¥</div>
                    <div class="stat-value">Â¥${totalReceived.toFixed(2)}</div>
                    <div class="stat-label">${records.filter(r => r.type === 'received').length} ç¬”è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»æ”¯å‡º</div>
                    <div class="stat-value">Â¥${totalGiven.toFixed(2)}</div>
                    <div class="stat-label">${records.filter(r => r.type === 'given').length} ç¬”è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å‡€æ”¶æ”¯</div>
                    <div class="stat-value">${balance >= 0 ? '+' : ''}Â¥${balance.toFixed(2)}</div>
                    <div class="stat-label">å…± ${records.length} ç¬”è®°å½•</div>
                </div>
            `;

            renderDetailedStats();
        }

        // æ¸²æŸ“è¯¦ç»†ç»Ÿè®¡
        function renderDetailedStats() {
            renderYearStats();
            renderEventStats();
        }

        // æ¸²æŸ“å¹´ä»½ç»Ÿè®¡
        function renderYearStats() {
            const yearStatsMap = {};
            
            records.forEach(record => {
                const year = new Date(record.date).getFullYear();
                if (!yearStatsMap[year]) {
                    yearStatsMap[year] = {
                        received: 0,
                        given: 0,
                        count: 0
                    };
                }
                
                if (record.type === 'received') {
                    yearStatsMap[year].received += record.amount;
                } else {
                    yearStatsMap[year].given += record.amount;
                }
                yearStatsMap[year].count++;
            });
            
            const yearStatsContainer = document.getElementById('year-stats');
            
            if (Object.keys(yearStatsMap).length === 0) {
                yearStatsContainer.innerHTML = '<p style="color: #999;">æš‚æ— æ•°æ®</p>';
                return;
            }
            
            const years = Object.keys(yearStatsMap).sort((a, b) => b - a);
            
            yearStatsContainer.innerHTML = years.map(year => {
                const stats = yearStatsMap[year];
                const balance = stats.received - stats.given;
                
                return `
                    <div class="year-stat-card" onclick="showYearEventStats('${year}')" id="year-card-${year}">
                        <div class="year-stat-year">${year} å¹´</div>
                        <div class="year-stat-amount" style="color: #52c41a;">æ”¶å…¥ Â¥${stats.received.toFixed(2)}</div>
                        <div class="year-stat-amount" style="color: #ff4757;">æ”¯å‡º Â¥${stats.given.toFixed(2)}</div>
                        <div class="year-stat-amount" style="color: ${balance >= 0 ? '#52c41a' : '#ff4757'};">
                            ä½™é¢ ${balance >= 0 ? '+' : ''}Â¥${balance.toFixed(2)}
                        </div>
                        <div class="year-stat-count">${stats.count} ç¬”è®°å½•</div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“äº‹ç”±ç»Ÿè®¡
        function renderEventStats(year = null) {
            // è¿‡æ»¤è®°å½•
            let filteredRecords = records;
            if (year) {
                filteredRecords = records.filter(r => new Date(r.date).getFullYear().toString() === year);
            }
            
            // æŒ‰äº‹ç”±ç»Ÿè®¡
            const eventStats = {};
            Object.keys(eventMap).forEach(key => {
                eventStats[key] = {
                    received: 0,
                    given: 0,
                    count: 0
                };
            });

            filteredRecords.forEach(record => {
                if (record.type === 'received') {
                    eventStats[record.event].received += record.amount;
                } else {
                    eventStats[record.event].given += record.amount;
                }
                eventStats[record.event].count++;
            });

            const detailedStatsContainer = document.getElementById('detailed-stats');
            detailedStatsContainer.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #e0e0e0;">äº‹ç”±</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #e0e0e0;">æ”¶å…¥</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #e0e0e0;">æ”¯å‡º</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #e0e0e0;">ç¬”æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(eventStats).map(([key, stats]) => `
                            <tr>
                                <td style="padding: 12px; border: 1px solid #e0e0e0;">${eventMap[key]}</td>
                                <td style="padding: 12px; text-align: right; color: #52c41a; border: 1px solid #e0e0e0;">
                                    Â¥${stats.received.toFixed(2)}
                                </td>
                                <td style="padding: 12px; text-align: right; color: #ff4757; border: 1px solid #e0e0e0;">
                                    Â¥${stats.given.toFixed(2)}
                                </td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #e0e0e0;">
                                    ${stats.count}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // æ˜¾ç¤ºæŒ‡å®šå¹´ä»½çš„äº‹ç”±ç»Ÿè®¡
        function showYearEventStats(year) {
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('event-stats-title').textContent = `ğŸ“Š äº‹ç”±ç»Ÿè®¡ï¼ˆ${year} å¹´ï¼‰`;
            
            // ç§»é™¤æ‰€æœ‰å¹´ä»½å¡ç‰‡çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.year-stat-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // æ¿€æ´»å½“å‰å¹´ä»½å¡ç‰‡
            const yearCard = document.getElementById(`year-card-${year}`);
            if (yearCard) {
                yearCard.classList.add('active');
            }
            
            // æ¸²æŸ“è¯¥å¹´ä»½çš„äº‹ç”±ç»Ÿè®¡
            renderEventStats(year);
            
            // æ»šåŠ¨åˆ°äº‹ç”±ç»Ÿè®¡åŒºåŸŸ
            document.getElementById('event-stats-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // åˆ‡æ¢ç»Ÿè®¡è§†å›¾
        function showStatsView(view) {
            if (view === 'summary') {
                document.getElementById('summary-view').style.display = 'block';
                document.getElementById('contacts-view').style.display = 'none';
            } else if (view === 'contacts') {
                document.getElementById('summary-view').style.display = 'none';
                document.getElementById('contacts-view').style.display = 'block';
                renderContacts();
            }
        }

        // æ¸²æŸ“äº²å‹å½•
        function renderContacts(searchText = '') {
            const contactsMap = {};
            
            // ç»Ÿè®¡æ¯ä¸ªäººçš„æ”¶æ”¯æƒ…å†µ
            records.forEach(record => {
                const name = record.name;
                if (!contactsMap[name]) {
                    contactsMap[name] = {
                        name: name,
                        relationship: record.relationship || 'å…¶ä»–',
                        received: 0,
                        given: 0,
                        receivedCount: 0,
                        givenCount: 0,
                        records: []
                    };
                }
                
                if (record.type === 'received') {
                    contactsMap[name].received += record.amount;
                    contactsMap[name].receivedCount++;
                } else {
                    contactsMap[name].given += record.amount;
                    contactsMap[name].givenCount++;
                }
                
                contactsMap[name].records.push(record);
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å…³ç³»åˆ†ç»„
            const contacts = Object.values(contactsMap);
            
            // è¿‡æ»¤æœç´¢
            const filteredContacts = searchText 
                ? contacts.filter(c => c.name.toLowerCase().includes(searchText.toLowerCase()))
                : contacts;
            
            // æŒ‰å…³ç³»åˆ†ç»„
            const groupedContacts = {};
            filteredContacts.forEach(contact => {
                const rel = contact.relationship || 'å…¶ä»–';
                if (!groupedContacts[rel]) {
                    groupedContacts[rel] = [];
                }
                groupedContacts[rel].push(contact);
            });
            
            const container = document.getElementById('contacts-container');
            
            if (filteredContacts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 48px;">ğŸ‘¥</p>
                        <p style="font-size: 18px; margin-top: 10px;">${searchText ? 'æœªæ‰¾åˆ°åŒ¹é…çš„äº²å‹' : 'æš‚æ— äº²å‹è®°å½•'}</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰å…³ç³»æ’åºï¼ˆå¸¸è§å…³ç³»åœ¨å‰ï¼‰
            const relationshipOrder = ['äº²æˆš', 'æœ‹å‹', 'åŒäº‹', 'åŒå­¦', 'é‚»å±…', 'å…¶ä»–'];
            const sortedGroups = Object.keys(groupedContacts).sort((a, b) => {
                const indexA = relationshipOrder.indexOf(a);
                const indexB = relationshipOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            container.innerHTML = sortedGroups.map(relationship => {
                const groupContacts = groupedContacts[relationship];
                const totalCount = groupContacts.length;
                
                return `
                    <div class="contact-group">
                        <div class="contact-group-title">
                            <span>${relationship}</span>
                            <span>${totalCount} äºº</span>
                        </div>
                        <div class="contact-list">
                            ${groupContacts.map(contact => {
                                const balance = contact.received - contact.given;
                                const balanceClass = balance > 0 ? 'positive' : balance < 0 ? 'negative' : '';
                                
                                return `
                                    <div class="contact-item" onclick="showContactDetail('${contact.name}')">
                                        <div class="contact-name">ğŸ‘¤ ${contact.name}</div>
                                        <div class="contact-stats">
                                            <span style="color: #52c41a;">æ”¶ ${contact.receivedCount}</span>
                                            <span style="color: #ff4757;">é€ ${contact.givenCount}</span>
                                        </div>
                                        <div class="contact-balance ${balanceClass}">
                                            ä½™é¢: ${balance >= 0 ? '+' : ''}Â¥${balance.toFixed(2)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // è¿‡æ»¤äº²å‹
        function filterContacts() {
            const searchText = document.getElementById('contact-search').value;
            renderContacts(searchText);
        }

        // æ˜¾ç¤ºäº²å‹è¯¦æƒ…
        function showContactDetail(name) {
            const contactRecords = records.filter(r => r.name === name);
            const received = contactRecords.filter(r => r.type === 'received');
            const given = contactRecords.filter(r => r.type === 'given');
            
            const totalReceived = received.reduce((sum, r) => sum + r.amount, 0);
            const totalGiven = given.reduce((sum, r) => sum + r.amount, 0);
            const balance = totalReceived - totalGiven;
            
            const relationship = contactRecords[0]?.relationship || 'æœªçŸ¥';
            
            const modalContent = `
                <button class="modal-close" onclick="closeModal()">âœ•</button>
                <h2 style="margin-bottom: 20px;">ğŸ‘¤ ${name}</h2>
                <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="color: #999; font-size: 12px;">å…³ç³»</div>
                            <div style="font-weight: bold; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <span id="display-relationship">${relationship}</span>
                                <button onclick="editRelationship('${name}', '${relationship}')" 
                                    style="background: #1890ff; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    âœï¸
                                </button>
                            </div>
                        </div>
                        <div>
                            <div style="color: #999; font-size: 12px;">æ”¶ç¤¼</div>
                            <div style="font-weight: bold; margin-top: 5px; color: #52c41a;">Â¥${totalReceived.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="color: #999; font-size: 12px;">é€ç¤¼</div>
                            <div style="font-weight: bold; margin-top: 5px; color: #ff4757;">Â¥${totalGiven.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="color: #999; font-size: 12px;">ä½™é¢</div>
                            <div style="font-weight: bold; margin-top: 5px; color: ${balance >= 0 ? '#52c41a' : '#ff4757'};">
                                ${balance >= 0 ? '+' : ''}Â¥${balance.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">ğŸ“‹ å¾€æ¥è®°å½•</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${contactRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${record.type === 'received' ? '#52c41a' : '#ff4757'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold;">${eventMap[record.event]}</span>
                                <span style="font-weight: bold; color: ${record.type === 'received' ? '#52c41a' : '#ff4757'};">
                                    ${record.type === 'received' ? '+' : '-'}Â¥${record.amount.toFixed(2)}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                <div>æ—¥æœŸ: ${record.date}</div>
                                ${record.location ? `<div>åœ°ç‚¹: ${record.location}</div>` : ''}
                                ${record.notes ? `<div>å¤‡æ³¨: ${record.notes}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const modal = document.getElementById('contact-modal');
            const modalContentDiv = document.getElementById('contact-modal-content');
            modalContentDiv.innerHTML = modalContent;
            modal.classList.add('show');
        }

        // ç¼–è¾‘å…³ç³»
        function editRelationship(name, currentRelationship) {
            const newRelationship = prompt('è¯·è¾“å…¥æ–°çš„å…³ç³»ï¼š', currentRelationship);
            
            if (newRelationship !== null && newRelationship.trim() !== '') {
                // æ›´æ–°æ‰€æœ‰è¯¥å§“åçš„è®°å½•
                let updated = false;
                records.forEach(record => {
                    if (record.name === name) {
                        record.relationship = newRelationship.trim();
                        updated = true;
                    }
                });
                
                if (updated) {
                    saveRecords();
                    // åˆ·æ–°æ¨¡æ€æ¡†
                    showContactDetail(name);
                    // åˆ·æ–°äº²å‹å½•
                    renderContacts(document.getElementById('contact-search').value);
                }
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('contact-modal');
            modal.classList.remove('show');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('contact-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ç¤¼è–„è¡¨å•æäº¤
        document.getElementById('gift-book-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const giftBook = {
                id: Date.now(),
                eventName: document.getElementById('gb-event-name').value,
                eventType: document.getElementById('gb-event-type').value,
                date: document.getElementById('gb-date').value,
                location: document.getElementById('gb-location').value,
                notes: document.getElementById('gb-notes').value,
                guests: [],
                createTime: new Date().toISOString()
            };

            giftBooks.push(giftBook);
            saveGiftBooks();
            
            // é‡ç½®è¡¨å•
            this.reset();
            document.getElementById('gb-date').valueAsDate = new Date();
            
            // å…³é—­è¡¨å•ï¼Œæ˜¾ç¤ºåˆ—è¡¨
            toggleGiftBookForm();
            
            alert('âœ… ç¤¼è–„åˆ›å»ºæˆåŠŸï¼');
        });

        // åˆ‡æ¢ç¤¼è–„è¡¨å•æ˜¾ç¤º/éšè—
        function toggleGiftBookForm() {
            const formContainer = document.getElementById('gift-book-form-container');
            const isVisible = formContainer.style.display !== 'none';
            
            if (isVisible) {
                formContainer.style.display = 'none';
                document.getElementById('create-giftbook-btn').textContent = 'â• åˆ›å»ºç¤¼è–„';
            } else {
                formContainer.style.display = 'block';
                document.getElementById('create-giftbook-btn').textContent = 'ğŸ“‹ æŸ¥çœ‹åˆ—è¡¨';
                // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // æ¸²æŸ“ç¤¼è–„åˆ—è¡¨
        function renderGiftBooks() {
            const container = document.getElementById('gift-books-container');
            console.log('æ¸²æŸ“ç¤¼è–„åˆ—è¡¨, æ•°é‡:', giftBooks.length);
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°ç¤¼è–„å®¹å™¨å…ƒç´ ');
                return;
            }
            
            if (giftBooks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 48px;">ğŸ“•</p>
                        <p style="font-size: 18px; margin-top: 10px;">æš‚æ— ç¤¼è–„</p>
                        <p style="font-size: 14px; margin-top: 5px;">åˆ›å»ºç¤¼è–„å¼€å§‹è®°å½•æ”¶ç¤¼æƒ…å†µ</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedBooks = [...giftBooks].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedBooks.map(book => {
                const totalAmount = book.guests.reduce((sum, guest) => sum + guest.amount, 0);
                const guestCount = book.guests.length;
                
                return `
                    <div class="record-card" style="border-left-color: #fa8c16;" id="giftbook-${book.id}">
                        <!-- ç¼–è¾‘è¡¨å• -->
                        <div id="giftbook-edit-form-${book.id}" style="display: none; background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin-bottom: 15px;">âœï¸ ç¼–è¾‘ç¤¼è–„</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; font-weight: bold;">äº‹ç”±åç§°</label>
                                <input type="text" id="edit-gb-name-${book.id}" value="${book.eventName}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; margin-top: 5px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="font-size: 12px; font-weight: bold;">äº‹ç”±ç±»å‹</label>
                                    <select id="edit-gb-type-${book.id}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; margin-top: 5px;">
                                        <option value="wedding" ${book.eventType === 'wedding' ? 'selected' : ''}>ç»“å©š</option>
                                        <option value="birthday" ${book.eventType === 'birthday' ? 'selected' : ''}>ç”Ÿæ—¥</option>
                                        <option value="housewarming" ${book.eventType === 'housewarming' ? 'selected' : ''}>ä¹”è¿</option>
                                        <option value="baby" ${book.eventType === 'baby' ? 'selected' : ''}>æ»¡æœˆ/ç™¾æ—¥</option>
                                        <option value="other" ${book.eventType === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; font-weight: bold;">æ—¥æœŸ</label>
                                    <input type="date" id="edit-gb-date-${book.id}" value="${book.date}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; margin-top: 5px;">
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; font-weight: bold;">åœ°ç‚¹</label>
                                <input type="text" id="edit-gb-location-${book.id}" value="${book.location || ''}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; margin-top: 5px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; font-weight: bold;">å¤‡æ³¨</label>
                                <textarea id="edit-gb-notes-${book.id}" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; margin-top: 5px; min-height: 60px;">${book.notes || ''}</textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-small" style="background: #52c41a; color: white; flex: 1;" onclick="saveGiftBookEdit(${book.id})">
                                    âœ… ä¿å­˜ä¿®æ”¹
                                </button>
                                <button class="btn btn-small" style="background: #d9d9d9; color: #333; flex: 1;" onclick="cancelGiftBookEdit(${book.id})">
                                    âŒ å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ˜¾ç¤ºå†…å®¹ -->
                        <div id="giftbook-display-${book.id}">
                        <div class="record-header">
                            <div>
                                <span class="record-name">${book.eventName}</span>
                                <span class="status-badge" style="background: #e6f7ff; color: #1890ff;">${eventMap[book.eventType]}</span>
                            </div>
                            <div class="record-amount" style="color: #fa8c16;">
                                Â¥${totalAmount.toFixed(2)}
                            </div>
                        </div>
                        <div class="record-details">
                            <div class="record-detail">
                                <strong>æ—¥æœŸï¼š</strong>${book.date}
                            </div>
                            <div class="record-detail">
                                <strong>å®¾å®¢ï¼š</strong>${guestCount} äºº
                            </div>
                            ${book.location ? `
                                <div class="record-detail">
                                    <strong>åœ°ç‚¹ï¼š</strong>${book.location}
                                </div>
                            ` : ''}
                        </div>
                        ${book.notes ? `
                            <div style="margin-top: 10px; color: #666; font-size: 14px;">
                                <strong>å¤‡æ³¨ï¼š</strong>${book.notes}
                            </div>
                        ` : ''}
                        
                        <!-- å®¾å®¢åˆ—è¡¨ -->
                        <div style="margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>ğŸ æ”¶ç¤¼æ˜ç»†</strong>
                                <button class="btn btn-small" style="background: #1890ff; color: white;" onclick="showAddGuestForm(${book.id})">
                                    â• æ·»åŠ å®¾å®¢
                                </button>
                            </div>
                            
                            <div id="guest-form-${book.id}" style="display: none; background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px dashed #1890ff;">
                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" id="guest-name-${book.id}" placeholder="å®¾å®¢å§“å" style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <input type="number" id="guest-amount-${book.id}" placeholder="é‡‘é¢" min="0" step="0.01" style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <input type="text" id="guest-relation-${book.id}" placeholder="å…³ç³»" style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-small" style="background: #52c41a; color: white; flex: 1;" onclick="addGuest(${book.id})">
                                        âœ… ä¿å­˜
                                    </button>
                                    <button class="btn btn-small" style="background: #d9d9d9; color: #333; flex: 1;" onclick="hideAddGuestForm(${book.id})">
                                        âŒ å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                            
                            ${book.guests.length > 0 ? `
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                        <thead>
                                            <tr style="background: #fafafa; position: sticky; top: 0;">
                                                <th style="padding: 10px; text-align: left; border: 1px solid #f0f0f0;">å§“å</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid #f0f0f0;">é‡‘é¢</th>
                                                <th style="padding: 10px; text-align: left; border: 1px solid #f0f0f0;">å…³ç³»</th>
                                                <th style="padding: 10px; text-align: center; border: 1px solid #f0f0f0; width: 120px;">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${book.guests.map(guest => `
                                                <tr id="guest-row-${guest.id}">
                                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">
                                                        <span id="guest-name-display-${guest.id}">${guest.name}</span>
                                                        <input type="text" id="guest-name-edit-${guest.id}" value="${guest.name}" style="display: none; width: 100%; padding: 4px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                                    </td>
                                                    <td style="padding: 10px; text-align: right; border: 1px solid #f0f0f0;">
                                                        <span id="guest-amount-display-${guest.id}" style="color: #52c41a; font-weight: bold;">Â¥${guest.amount.toFixed(2)}</span>
                                                        <input type="number" id="guest-amount-edit-${guest.id}" value="${guest.amount}" step="0.01" style="display: none; width: 100%; padding: 4px; border: 1px solid #d9d9d9; border-radius: 4px; text-align: right;">
                                                    </td>
                                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">
                                                        <span id="guest-relation-display-${guest.id}">${guest.relationship || '-'}</span>
                                                        <input type="text" id="guest-relation-edit-${guest.id}" value="${guest.relationship || ''}" style="display: none; width: 100%; padding: 4px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                                    </td>
                                                    <td style="padding: 10px; text-align: center; border: 1px solid #f0f0f0;">
                                                        <div id="guest-actions-${guest.id}">
                                                            <button class="btn btn-small" onclick="editGuest(${book.id}, ${guest.id})" style="padding: 4px 8px; background: #1890ff; color: white;">
                                                                ç¼–è¾‘
                                                            </button>
                                                            <button class="btn btn-small btn-delete" onclick="deleteGuest(${book.id}, ${guest.id})" style="padding: 4px 8px;">
                                                                åˆ é™¤
                                                            </button>
                                                        </div>
                                                        <div id="guest-save-${guest.id}" style="display: none;">
                                                            <button class="btn btn-small" onclick="saveGuestEdit(${book.id}, ${guest.id})" style="padding: 4px 8px; background: #52c41a; color: white;">
                                                                ä¿å­˜
                                                            </button>
                                                            <button class="btn btn-small" onclick="cancelGuestEdit(${book.id}, ${guest.id})" style="padding: 4px 8px; background: #d9d9d9; color: #333;">
                                                                å–æ¶ˆ
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 20px; color: #999; background: #fafafa; border-radius: 8px;">
                                    æš‚æ— å®¾å®¢è®°å½•
                                </div>
                            `}
                        </div>
                        
                        <div class="record-actions" style="margin-top: 15px;">
                            <button class="btn btn-small" style="background: #1890ff; color: white;" onclick="showGiftBookEdit(${book.id})">
                                âœï¸ ç¼–è¾‘ç¤¼è–„
                            </button>
                            <button class="btn btn-small" style="background: #1890ff; color: white;" onclick="exportGiftBook(${book.id})">
                                ğŸ“¥ å¯¼å‡ºç¤¼è–„
                            </button>
                            <button class="btn btn-small btn-delete" onclick="deleteGiftBook(${book.id})">
                                ğŸ—‘ï¸ åˆ é™¤ç¤¼è–„
                            </button>
                        </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºç¤¼è–„ç¼–è¾‘è¡¨å•
        function showGiftBookEdit(bookId) {
            document.getElementById(`giftbook-display-${bookId}`).style.display = 'none';
            document.getElementById(`giftbook-edit-form-${bookId}`).style.display = 'block';
        }

        // å–æ¶ˆç¤¼è–„ç¼–è¾‘
        function cancelGiftBookEdit(bookId) {
            document.getElementById(`giftbook-display-${bookId}`).style.display = 'block';
            document.getElementById(`giftbook-edit-form-${bookId}`).style.display = 'none';
        }

        // ä¿å­˜ç¤¼è–„ç¼–è¾‘
        function saveGiftBookEdit(bookId) {
            const book = giftBooks.find(b => b.id === bookId);
            if (!book) return;
            
            const oldDate = book.date;
            const oldEventType = book.eventType;
            const oldLocation = book.location;
            
            book.eventName = document.getElementById(`edit-gb-name-${bookId}`).value;
            book.eventType = document.getElementById(`edit-gb-type-${bookId}`).value;
            book.date = document.getElementById(`edit-gb-date-${bookId}`).value;
            book.location = document.getElementById(`edit-gb-location-${bookId}`).value;
            book.notes = document.getElementById(`edit-gb-notes-${bookId}`).value;
            
            // åŒæ­¥æ›´æ–°æ‰€æœ‰å…³è”æ­¤ç¤¼è–„çš„è®°å½•
            records.forEach(record => {
                if (record.giftBookId == bookId) {
                    record.event = book.eventType;
                    record.date = book.date;
                    record.location = book.location || '';
                    // æ›´æ–°å¤‡æ³¨ä¸­çš„ç¤¼è–„åç§°
                    if (record.notes && record.notes.includes('æ¥è‡ªç¤¼è–„ï¼š')) {
                        record.notes = `æ¥è‡ªç¤¼è–„ï¼š${book.eventName}`;
                    }
                }
            });
            
            saveRecords();
            saveGiftBooks();
            alert('âœ… ç¤¼è–„å·²æ›´æ–°ï¼å…³è”çš„è®°å½•ä¹Ÿå·²åŒæ­¥æ›´æ–°ã€‚');
        }

        // æ˜¾ç¤ºæ·»åŠ å®¾å®¢è¡¨å•
        function showAddGuestForm(bookId) {
            const form = document.getElementById(`guest-form-${bookId}`);
            form.style.display = 'block';
        }

        // éšè—æ·»åŠ å®¾å®¢è¡¨å•
        function hideAddGuestForm(bookId) {
            const form = document.getElementById(`guest-form-${bookId}`);
            form.style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById(`guest-name-${bookId}`).value = '';
            document.getElementById(`guest-amount-${bookId}`).value = '';
            document.getElementById(`guest-relation-${bookId}`).value = '';
        }

        // æ·»åŠ å®¾å®¢
        function addGuest(bookId) {
            const name = document.getElementById(`guest-name-${bookId}`).value.trim();
            const amount = parseFloat(document.getElementById(`guest-amount-${bookId}`).value);
            const relationship = document.getElementById(`guest-relation-${bookId}`).value.trim();
            
            if (!name || !amount || amount <= 0) {
                alert('âŒ è¯·å¡«å†™å®¾å®¢å§“åå’Œæœ‰æ•ˆé‡‘é¢ï¼');
                return;
            }
            
            const book = giftBooks.find(b => b.id === bookId);
            if (book) {
                const guestId = Date.now();
                const guest = {
                    id: guestId,
                    name: name,
                    amount: amount,
                    relationship: relationship || ''
                };
                
                book.guests.push(guest);
                
                // åŒæ—¶åœ¨è®°å½•åˆ—è¡¨ä¸­åˆ›å»ºæ”¶ç¤¼è®°å½•
                const record = {
                    id: guestId,
                    type: 'received',
                    name: name,
                    amount: amount,
                    date: book.date,
                    event: book.eventType,
                    relationship: relationship || '',
                    location: book.location || '',
                    notes: `æ¥è‡ªç¤¼è–„ï¼š${book.eventName}`,
                    giftBookId: bookId,
                    createTime: new Date().toISOString()
                };
                
                records.push(record);
                saveRecords();
                saveGiftBooks();
                hideAddGuestForm(bookId);
            }
        }

        // ç¼–è¾‘å®¾å®¢
        function editGuest(bookId, guestId) {
            // æ˜¾ç¤ºç¼–è¾‘æ¡†ï¼Œéšè—æ˜¾ç¤ºæ–‡æœ¬
            document.getElementById(`guest-name-display-${guestId}`).style.display = 'none';
            document.getElementById(`guest-name-edit-${guestId}`).style.display = 'block';
            document.getElementById(`guest-amount-display-${guestId}`).style.display = 'none';
            document.getElementById(`guest-amount-edit-${guestId}`).style.display = 'block';
            document.getElementById(`guest-relation-display-${guestId}`).style.display = 'none';
            document.getElementById(`guest-relation-edit-${guestId}`).style.display = 'block';
            document.getElementById(`guest-actions-${guestId}`).style.display = 'none';
            document.getElementById(`guest-save-${guestId}`).style.display = 'block';
        }

        // ä¿å­˜å®¾å®¢ç¼–è¾‘
        function saveGuestEdit(bookId, guestId) {
            const book = giftBooks.find(b => b.id === bookId);
            if (!book) return;
            
            const guest = book.guests.find(g => g.id === guestId);
            if (!guest) return;
            
            const newName = document.getElementById(`guest-name-edit-${guestId}`).value.trim();
            const newAmount = parseFloat(document.getElementById(`guest-amount-edit-${guestId}`).value);
            const newRelation = document.getElementById(`guest-relation-edit-${guestId}`).value.trim();
            
            if (!newName || !newAmount || newAmount <= 0) {
                alert('âŒ è¯·å¡«å†™æœ‰æ•ˆçš„å§“åå’Œé‡‘é¢ï¼');
                return;
            }
            
            // æ›´æ–°ç¤¼è–„ä¸­çš„å®¾å®¢ä¿¡æ¯
            guest.name = newName;
            guest.amount = newAmount;
            guest.relationship = newRelation;
            
            // åŒæ­¥æ›´æ–°è®°å½•åˆ—è¡¨ä¸­çš„å¯¹åº”è®°å½•
            const record = records.find(r => r.id === guestId);
            if (record) {
                record.name = newName;
                record.amount = newAmount;
                record.relationship = newRelation;
                saveRecords();
            }
            
            saveGiftBooks();
            cancelGuestEdit(bookId, guestId);
            alert('âœ… å®¾å®¢ä¿¡æ¯å·²æ›´æ–°ï¼');
        }

        // å–æ¶ˆå®¾å®¢ç¼–è¾‘
        function cancelGuestEdit(bookId, guestId) {
            // éšè—ç¼–è¾‘æ¡†ï¼Œæ˜¾ç¤ºæ–‡æœ¬
            document.getElementById(`guest-name-display-${guestId}`).style.display = 'inline';
            document.getElementById(`guest-name-edit-${guestId}`).style.display = 'none';
            document.getElementById(`guest-amount-display-${guestId}`).style.display = 'inline';
            document.getElementById(`guest-amount-edit-${guestId}`).style.display = 'none';
            document.getElementById(`guest-relation-display-${guestId}`).style.display = 'inline';
            document.getElementById(`guest-relation-edit-${guestId}`).style.display = 'none';
            document.getElementById(`guest-actions-${guestId}`).style.display = 'block';
            document.getElementById(`guest-save-${guestId}`).style.display = 'none';
        }

        // åˆ é™¤å®¾å®¢
        function deleteGuest(bookId, guestId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä½å®¾å®¢çš„è®°å½•å—ï¼Ÿ\nåŒæ—¶ä¼šåˆ é™¤è®°å½•åˆ—è¡¨ä¸­çš„å¯¹åº”è®°å½•ã€‚')) {
                const book = giftBooks.find(b => b.id === bookId);
                if (book) {
                    book.guests = book.guests.filter(g => g.id !== guestId);
                    
                    // åŒæ—¶åˆ é™¤è®°å½•åˆ—è¡¨ä¸­çš„å¯¹åº”è®°å½•
                    const recordIndex = records.findIndex(r => r.id === guestId && r.giftBookId == bookId);
                    if (recordIndex !== -1) {
                        records.splice(recordIndex, 1);
                        saveRecords();
                    }
                    
                    saveGiftBooks();
                }
            }
        }

        // åˆ é™¤ç¤¼è–„
        function deleteGiftBook(bookId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç¤¼è–„å—ï¼Ÿæ‰€æœ‰å®¾å®¢è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ã€‚')) {
                giftBooks = giftBooks.filter(b => b.id !== bookId);
                saveGiftBooks();
            }
        }

        // å¯¼å‡ºç¤¼è–„
        function exportGiftBook(bookId) {
            const book = giftBooks.find(b => b.id === bookId);
            if (!book) return;
            
            const totalAmount = book.guests.reduce((sum, guest) => sum + guest.amount, 0);
            
            let content = `ç¤¼è–„ï¼š${book.eventName}\n`;
            content += `äº‹ç”±ï¼š${eventMap[book.eventType]}\n`;
            content += `æ—¥æœŸï¼š${book.date}\n`;
            if (book.location) content += `åœ°ç‚¹ï¼š${book.location}\n`;
            if (book.notes) content += `å¤‡æ³¨ï¼š${book.notes}\n`;
            content += `\n===================\n`;
            content += `å®¾å®¢æ˜ç»†ï¼ˆå…±${book.guests.length}äººï¼‰\n`;
            content += `===================\n\n`;
            
            book.guests.forEach((guest, index) => {
                content += `${index + 1}. ${guest.name}\tÂ¥${guest.amount.toFixed(2)}`;
                if (guest.relationship) content += `\t${guest.relationship}`;
                content += `\n`;
            });
            
            content += `\n===================\n`;
            content += `æ€»è®¡ï¼šÂ¥${totalAmount.toFixed(2)}\n`;
            
            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç¤¼è–„_${book.eventName}_${book.date}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ç¤¼è–„å·²å¯¼å‡ºï¼');
        }
    </script>
</body>
</html>
